---
title: "porocilo"
author: "Sebastjan Senk"
date: "2025"
output: html_document
---

# 1. Igra in pravila (na kratko)

**Blackjack** je igra s kartami v kateri med seboj igrata igralec–delivec: cilj je biti bližje 21 toda ne več kot 21. Naravni 21 (A + 10/J/Q/K) ima posebno izplačilo.

**Kompleti in vrednosti kart:** igra se s standardnim kompletom (pogosto več njih v *shoe*).\
2–10 → vrednost = številka; J/Q/K → 10; A → 1 ali 11 (mehka roka, *soft*).

**Potek:** 1) razdelitev dveh kart (delivčeva *upcard* je vidna),\
2) morebiten naravni blackjack,\
3) igralčeve poteze: *hit*, *stand*, *double*, *split*, *surrender* (če je dovoljeno),\
4) delivec vleče do ≥17; pri **H17** vleče tudi na *soft 17*, pri **S17** ne,\
5) primerjava (zmaga/poraz/*push*).

**Parametri, ki jih spreminjamo v simulacijah:** število kompletov, različne strategije igralca(demo/osnovna/napredna), H17/S17, izplačilo za BJ (3:2 ali 6:5), *surrender*, double, split, penetracija (delež odigranih kart pred mešanjem).

**Metrike:** dobiček na stavo $G$, verjetnosti izidov (win/lose/push), volatilnost (aka. standardni odklon), več v nadaljevanju.\
**House edge:** $\mathrm{HE}=-\mathbb{E}[G]$. Negativen $\mathbb{E}[G]$ pomeni prednost hiše. Ta enakost velja kadar je \$G\$ dobiček na roko pri stavi 1. Ker pa imamo tudi implementirano pravilo double in kasneje napredno Hi-Lo strategijo, je bolj smiselno gledati \$HE_per_bet\$, torej house edhe na enoto vložka, ki jo izračunamo na naslednji način: $$HE_{\text{per bet}} = -\frac{\mathbb{E}[G]}{\mathbb{E}[\text{bet}]}$$

------------------------------------------------------------------------

# 2. Strategije igranja

## 2.1 Uvod in oznake

Strategija določa, **kako igralec izbira poteze** na podlagi stanja igre. Stanje formalno:

$$
s = (V_P, V_D, S_P, P_P)
$$kjer:

\- $V_P$ — vsota igralčevih kart (ase štejemo kot 1 ali 11),\
- $V_D$ — delivčeva vidna karta (*upcard*),\
- $S_P$ — indikator mehke roke (TRUE, če as šteje kot 11),\
- $P_P$ — indikator para (možen *split*).

Strategija je funkcija:

$$
\pi(s) = a, \quad a \in \{\text{hit}, \text{stand}, \text{double}, \text{split}, \text{surrender}\}.
$$

## 2.2 Vrste strategij

| Tip strategije                                                           | Opis                                                                           | Namen                   |
|--------------------------|----------------------------|------------------|
| **Naključna (nej bo ta "demo" verzija nakljucna, osnovna bo pa tabela)** | Poteze brez logike.                                                            | Kontrolni primer.       |
| **Osnovna (Basic)**                                                      | Optimalna glede na pričakovani izid, brez štetja kart.                         | Standard v simulacijah. |
| **Napredna**                                                             | Uporabi dodatne informacije (npr. štetje kart) za prilagoditev potez in stave. | Poveča dolgoročni $EV$. |

V nadaljevanju uporabljamo **osnovno strategijo**.

## 2.3 Matematični model odločanja

Pričakovani dobiček poteze $a$ v stanju $s$:

$$
EV(s,a) = \sum_{s'} P(s' \mid s,a)\, R(s,a,s'),
$$

kjer je $P(\cdot)$ verjetnost prehoda, $R(\cdot)$ izplačilo. Optimalna poteza:

$$
\pi^*(s) = \arg\max_a EV(s,a).
$$

V praksi tabelo $\pi^*$ dobimo z DP ali simulacijo → **tabela osnovne strategije**.

## 2.4 Osnovna strategija (izsek za *hard* roke)

Vir (prilagojeno): <https://www.blackjackonlineigra.eu/article/tabela-za-osnovno-strategijo-igranja-blackjacka>

<https://www.blackjackapprenticeship.com/blackjack-strategy-charts/>

**Nastavitve:** 6 kompletov kart, S17 (*dealer stands on soft 17*), dodan tudi H17

**Legenda:**\
- **H** = *Hit*\
- **S** = *Stand*\
- **D** = *Double* (če ni možno, vzemi *Hit*)\
- **Ds** = *Double* (če ni možno, vzemi *Stand*)\
- **P** = *Split*\
- **R** = *Surrender*

Tabela prikazuje optimalne poteze za *hard totals* (roka brez asa ali z asom, ki šteje kot 1).\
Soft roke in pari so v ločenih tabelah.

### Hard totals (osnovna strategija)

| Igralčeva vsota |  2  |  3  |  4  |  5  |  6  |  7  |  8  |  9  | 10  |  A  |
|----------------:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|      8 ali manj |  H  |  H  |  H  |  H  |  H  |  H  |  H  |  H  |  H  |  H  |
|               9 |  H  |  D  |  D  |  D  |  D  |  H  |  H  |  H  |  H  |  H  |
|              10 |  D  |  D  |  D  |  D  |  D  |  D  |  D  |  D  |  H  |  H  |
|              11 |  D  |  D  |  D  |  D  |  D  |  D  |  D  |  D  |  D  |  H  |
|              12 |  H  |  H  |  S  |  S  |  S  |  H  |  H  |  H  |  H  |  H  |
|           13–16 |  S  |  S  |  S  |  S  |  S  |  H  |  H  |  H  |  H  |  H  |
|      17 ali več |  S  |  S  |  S  |  S  |  S  |  S  |  S  |  S  |  S  |  S  |

*Opomba:* Pari (npr. 10–10, 8–8, A–A) in *soft* roke (A+X) imajo ločene sezname optimalnih potez

------------------------------------------------------------------------

## 2.5 Napredna strategija — štetje kart (Hi–Lo)

**Hi–Lo** je klasična metoda štetja kart, kjer se vsaki karti dodeli vrednost:

-   **+1:** 2, 3, 4, 5, 6\
-   **0:** 7, 8, 9\
-   **−1:** 10, J, Q, K, A

S tem nastane **tekoči count (RC)**:

$$
RC = \sum \text{vrednosti vseh do sedaj videnih kart}
$$

Ker je v igri več kompletov kart (npr. 6), je potrebno popraviti pristranskost z deljenjem:

### **True Count**

$$
TC = \frac{RC}{\text{decks remaining}}
$$

kjer je število preostalih kompletov ocenjeno kot:

$$
\text{decks_remaining} = (\text{total_cards} - \text{pos} + 1) / 52.
$$

### Interpretacija TC

Pri $TC>0$ ima igralec statistično prednost → poveča stavo; pri $TC<0$ stavi minimalno.

-   **TC \< 0**: v preostalih kartah je *preveč malih kart* → igralec je v slabšem položaju\
    → *stavi minimum*\
-   **TC ≈ 0**: približno pošteno (se zmeraj kar minimum stavimo)\
-   **TC \> 0**: v preostalih kartah je *več desetk in asov* → igralec ima prednost\
    → *povečuje stavo*

V našem Monte Carlo modelu uporabljamo preprost bet spread (primer):

-   TC ≤ 0 → 1× osnovna stava\
-   1 ≤ TC \< 2 → 2×\
-   2 ≤ TC \< 3 → 4×\
-   TC ≥ 3 → 8×

S tem lahko simuliramo vpliv štetja kart na pričakovani dobiček (EV).

## 2.6 Povzetek

-   Strategija je $\pi(s)$, ki maksimizira $EV(s,a)$.\
-   V simulacijah uporabljamo **osnovno strategijo**; parametre pravil (H17/S17, izplačila, št. kompletov) spreminjamo.

## 2.7 Implementacija osnovne strategije v R

Osnovna strategija je v kodi implementirana preko funkcije:

``` r
basic_action_bs(player_vals, dealer_up, can_double, can_split, bs_table)
```

ki glede na igralčevo roko, delivčevo *upcard* in pravila igre (H17 ali S17) izbere optimalno potezo iz CSV tabele.

Uporabljam dve ločeni tabeli osnovne strategije:

-   `basic_strategy.csv` — pravila za **S17** (*dealer stands on soft 17*)
-   `basic_strategy_H17.csv` — pravila za **H17** (*dealer hits soft 17*)

Vsaka vrstica v CSV vsebuje: - tip roke, aka. `player_group` (`hard`, `soft`, `pair`) - igralčevo vrednost (`player_total` ali `pair_rank`) - delivčevo karto (`dealer_up`) - optimalno akcijo (`H, S, D, Ds, P, R`)

Postopek izvajanja: 1. roka se razvrsti med *hard*, *soft* ali *pair* 2. iz ustrezne CSV se izbere optimalna vrstica 3. akcijska koda se prevede v potezo (*hit*, *stand*, *double*, *split*, *surrender*)

Pravila H17/S17 preklapljamo zgolj z izbiro druge CSV tabele.

------------------------------------------------------------------------

# 3. Simulacijski model in metrike

## 3.1 Struktura simulacije

Simulacija ima dva nivoja:

### (1) Simulacija ene roke

Funkciji `deal_hand_from_shoe()` in `deal_hand_from_shoe_hilo()` izvedeta:\
1. začetno deljenje (P1, D_up, P2, D_hole)\
2. preverjanje blackjacka\
3. igralčevo igro po osnovni strategiji\
4. delivčevo igro po pravilih H17 ali S17\
5. izračun dobička roke\
6. beleženje dogodkov:\
- blackjack igralca / delivca\
- bust igralca / delivca\
- surrender\
- double\
- pri Hi–Lo: posodobitev tekočega counta (running count)

### (2) Monte Carlo simulacija (N zaporednih rok)

-   `simulate_with_shoe()` — osnovna strategija, fiksna stava
-   `simulate_with_shoe_hilo()` — strategija + Hi–Lo štetje + bet spread

Obe simulaciji: - inicializirata *shoe* z dano penetracijo - pred vsako roko preverita, ali je treba ponovno premešati - zbirata izide v vektor `gains` - beležita indikatorje (BJ, bust, double, surrender) - izračunata statistične metrike

------------------------------------------------------------------------

## 3.2 Metrike, ki jih vračata simulaciji

### 3.2.1 Osnovne statistike dobička

Pričakovani dobiček na roko:

$$
EV = \frac{1}{N}\sum_{i=1}^{N} G_i
$$

Varianca in standardni odklon:

$$
SD = \sqrt{\mathrm{Var}(G)}
$$

Standardna napaka ocene:

$$
SE = \frac{SD}{\sqrt{N}}
$$

95% interval zaupanja:

$$
EV \pm 1.96 \cdot SE
$$

Pri Hi–Lo simulaciji dodatno:

$$
EV_{100} = 100 \cdot EV
$$

------------------------------------------------------------------------

### 3.2.2 Porazdelitev osnovnih izidov

-   **Win rate:**\
    $$ P(G > 0) $$
-   **Loss rate:**\
    $$ P(G < 0) $$
-   **Push rate:**\
    $$ P(G = 0) $$

------------------------------------------------------------------------

### 3.2.3 Posebni dogodki (frekvence)

Simulacija meri:\
- blackjack igralca\
- blackjack delivca\
- surrender\
- bust igralca\
- bust delivca\
- double\

------------------------------------------------------------------------

### 3.2.4 Bankroll in tveganje

Potek kapitala:

$$
\text{bankroll}(i) = \sum_{k=1}^{i} G_k
$$

Drawdown (padec od lokalnega maksimuma):

$$
DD(i) = \max_{j \le i} \text{bankroll}(j) - \text{bankroll}(i)
$$

Največji drawdown:

$$
\text{MaxDD} = \max_i DD(i)
$$

------------------------------------------------------------------------

### 3.2.5 Hi–Lo specifične metrike

Tekoči count:

$$
C = \sum \text{(vrednosti vseh do sedaj videnih kart)}
$$

True count:

$$
TC = \frac{C}{\text{decks remaining}}
$$

kjer:

$$
\text{decks remaining} = \frac{\text{total_cards} - \text{pos} + 1}{52}
$$

ROI — donos na vložek:

$$
ROI = \frac{\sum_i G_i}{\sum_i \text{bet}_i}
$$

Pogojni EV glede na TC:

$$
EV(TC = t) = \mathbb{E}[G \mid \text{round}(TC) = t]
$$

------------------------------------------------------------------------

## 3.3 Povzetek simulacijskega dela

-   Osnovna strategija je implementirana preko CSV tabel (S17, H17)
-   Simulaciji `simulate_with_shoe()` in `simulate_with_shoe_hilo()` izvajata realistično Monte Carlo simulacijo blackjacka z mešanjem glede na penetracijo
-   Izračunane so metrike: EV, SD, SE, 95% CI, frekvence BJ/bust/double/surrender, potek bankrolla, max drawdown
-   Hi–Lo razširitev vključuje: running count, true count, bet spread, ROI, EV po TC
-   Te metrike omogočajo analizo vpliva pravil igre ter oceno prednosti pri štetju kart

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

*Prijekt se mi zdi se zelo obsezen, ce pa morda ni dovolj pa lahko dodajam se: razvoj proper splita (resplit, Das), kelly func za hilo (opt bet size), skewness,kurtosis za porazdelitev dobitkov(ker je zlo nesimetricn), RoR(Risk of ruin)...na to temo bi lahko pol nardil se celo igro Janezek gre v Casino XD, Hit frequency, etc(pac to se lahko ceu magisterij iz tega spise ce bi se tok zajebavu s tem XD)*

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

# 4. Primerjava strategij in rezultati simulacij

V nadaljevanju primerjam rezultate Monte Carlo simulacij. Privzeto uporabljam:

-   6 kompletov kart (*n_decks = 6*)
-   **S17** (dealer stoji na soft 17), razen tam kjer primerjam S17 vs H17
-   *double* in *surrender* sta dovoljena
-   *split* je privzeto izklopljen (ker implementacija ni popolnoma zaključena) in ga vključim samo pri posebni primerjavi
-   izplačilo blackjacka 3:2 (*payout_bj = 1.5*)
-   velikost vzorca: $N = 10^6$ (če ni navedeno drugače)

-\> EV_per_hand pove, koliko povprečno dobimo/izgubimo na eno roko (pri negativni vrednosti dolgoročno izgubljamo).

-\> Pri Hi–Lo je EV_per_hand lahko bolj negativen, ker so stave višje (večja volatilnost), zato se bolj splača gledati HE_per_bet.

-\> HE_per_bet je bolj “poštena” primerjava, ker pove izgubo na enoto vložka. Nižji HE_per_bet pomeni boljši rezultat za igralca.

-\> Pri Hi–Lo je povprečna stava (avg_bet) večja, zato je smiselno primerjati tudi ROI. Primerjava strategij (demo vs basic vs Hi-Lo)

## 4.1 Primerjava strategij: demo vs basic vs Hi–Lo

Najprej primerjam tri strategije pri istih pravilih:

-   **Demo / random**: kontrolni primer, naključno igranje
-   **Basic (shoe)**: osnovna strategija iz CSV tabel (S17/H17)
-   **Hi–Lo (shoe + spread)**: štetje kart + prilagajanje stave (bet spread)

| Strategija            | $EV_{\text{per hand}}$ | $HE_{\text{per hand}}$ | $HE_{\text{per bet}}$ |     $ROI$ | $\overline{\text{bet}}$ |
|------------|-----------:|-----------:|-----------:|-----------:|-----------:|
| Demo / random         |              -0.037238 |               0.037238 |              0.037238 | -0.037238 |                   1.000 |
| Basic (shoe)          |              -0.040783 |               0.040783 |              0.035375 | -0.035375 |                   1.153 |
| Hi-Lo (shoe + spread) |              -0.055703 |               0.055703 |              0.025605 | -0.025605 |                   2.176 |

Naključna strategija predstavlja referenčni primer brez uporabe kakršnegakoli znanja o igri. Pričakovani dobiček na roko je izrazito negativen, kar pomeni visoko prednost hiše.

Osnovna strategija bistveno izboljša rezultate v primerjavi z naključnim igranjem. Čeprav je $EV$ še vedno negativen, in celo slabši od naključne strategije, se house edge na enoto stave zmanjša, kar pomeni počasnejše dolgoročne izgube.

Hi–Lo strategija ima na prvi pogled najslabši $EV$ na roko, vendar to ni ustrezna metrika za primerjavo. Zaradi večjih stav pri ugodnih situacijah (visok *true count*) se poveča povprečna stava, kar vpliva na absolutni dobiček na roko.

Ključni kazalnik je $HE_{\text{per_bet}}$, ki je pri Hi–Lo strategiji najnižji. To pomeni, da igralec na enoto vloženega denarja izgublja najmanj, kar je tudi osnovni cilj štetja kart.

-   Naključno igranje vodi do največjih izgub.

-   Osnovna strategija znatno zmanjša prednost hiše, vendar igre ne naredi poštene.

-   Hi–Lo strategija zmanjša house edge na enoto stave, čeprav poveča povprečno velikost vložka.

-   Za pozitivni $EV$ bi bile potrebne dodatne izboljšave (večja penetracija, bolj agresiven *bet spread*, *index plays*).

Na podlagi simulacij lahko zaključimo, da štetje kart ne zagotavlja dobitka v vsaki igri, vendar dolgoročno izboljša položaj igralca v primerjavi z osnovno strategijo.

## 4.2 Primerjava pravil delivca: S17 vs H17

V tej sekciji primerjam, kako sprememba delivčevega pravila vpliva na rezultate:

-   **S17**: delivec stoji na *soft 17*
-   **H17**: delivec vleče tudi na *soft 17*

Za primerljivost uporabim isti `set.seed()` in isti $N$.

```{r basic_s17_h17_table, echo=FALSE, message=FALSE, warning=FALSE}

df_basic_rules <- data.frame( pravilo = c("S17", "H17"), EV = c(-0.042195, -0.043469), SE = c(0.001163088, 0.001163590), HE_per_bet = c(0.03660209, 0.03761544), avg_bet = c(1.152803, 1.155616) )

```

Pri **H17** ima delivec malo več “opcij”, ker lahko vleče tudi na *soft 17*. To v povprečju nekoliko poveča prednost hiše, zato je pričakovani dobiček igralca (**EV**) malo bolj negativen, prav tako je nekoliko višji **HE_per_bet**.

## 4.3 Vpliv pravil: double / surrender / split

V tej sekciji pogledam, kako se rezultati spremenijo, če določena pravila dovolimo ali prepovemo.

-   **Double**: igralec lahko podvoji stavo, vendar dobi točno še eno karto.
-   **Surrender**: igralec lahko takoj odstopi in izgubi polovico stave.
-   **Split**: ob paru lahko razdeli roko na dve roki (v tem projektu je split privzeto izklopljen).

3.1. HE vs. pravila igre

3.2. EV_by_TC – EV glede na true count

3.3. Bankroll curve (časovna dinamika)

3.4. Histogram dobitkov

3.5. Penetration vs EV (pri Hi-Lo)

3.6. ROI vs HE pri različnih strategijah
